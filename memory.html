<!DOCTYPE HTML>
<html lang="en" class="light sidebar-visible" dir="ltr">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>内存管理 - C# 面试笔记</title>


        <!-- Custom HTML head -->

        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff">

        <link rel="icon" href="favicon.svg">
        <link rel="shortcut icon" href="favicon.png">
        <link rel="stylesheet" href="css/variables.css">
        <link rel="stylesheet" href="css/general.css">
        <link rel="stylesheet" href="css/chrome.css">
        <link rel="stylesheet" href="css/print.css" media="print">

        <!-- Fonts -->
        <link rel="stylesheet" href="FontAwesome/css/font-awesome.css">
        <link rel="stylesheet" href="fonts/fonts.css">

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="highlight.css">
        <link rel="stylesheet" href="tomorrow-night.css">
        <link rel="stylesheet" href="ayu-highlight.css">

        <!-- Custom theme stylesheets -->
        <link rel="stylesheet" href="theme/pagetoc.css">
        <link rel="stylesheet" href="./mdbook-admonish.css">


        <!-- Provide site root to javascript -->
        <script>
            var path_to_root = "";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "navy" : "light";
        </script>
        <!-- Start loading toc.js asap -->
        <script src="toc.js"></script>
    </head>
    <body>
    <div id="body-container">
        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script>
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script>
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            const html = document.documentElement;
            html.classList.remove('light')
            html.classList.add(theme);
            html.classList.add("js");
        </script>

        <input type="checkbox" id="sidebar-toggle-anchor" class="hidden">

        <!-- Hide / unhide sidebar before it is displayed -->
        <script>
            var sidebar = null;
            var sidebar_toggle = document.getElementById("sidebar-toggle-anchor");
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            } else {
                sidebar = 'hidden';
            }
            sidebar_toggle.checked = sidebar === 'visible';
            html.classList.remove('sidebar-visible');
            html.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <!-- populated by js -->
            <mdbook-sidebar-scrollbox class="sidebar-scrollbox"></mdbook-sidebar-scrollbox>
            <noscript>
                <iframe class="sidebar-iframe-outer" src="toc.html"></iframe>
            </noscript>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle">
                <div class="sidebar-resize-indicator"></div>
            </div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky">
                    <div class="left-buttons">
                        <label id="sidebar-toggle" class="icon-button" for="sidebar-toggle-anchor" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </label>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                    </div>

                    <h1 class="menu-title">C# 面试笔记</h1>

                    <div class="right-buttons">
                        <a href="print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>

                    </div>
                </div>

                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script>
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <div class="content-wrap">
                            <h1 id="内存管理"><a class="header" href="#内存管理">内存管理</a></h1>
<h2 id="c-中堆和栈的区别"><a class="header" href="#c-中堆和栈的区别">C# 中堆和栈的区别？</a></h2>
<div class="table-wrapper"><table><thead><tr><th style="text-align: left"><strong>对比维度</strong></th><th style="text-align: left"><strong>栈（Stack）</strong></th><th style="text-align: left"><strong>堆（Heap）</strong></th></tr></thead><tbody>
<tr><td style="text-align: left"><strong>存储内容</strong></td><td style="text-align: left">值类型（<code>int</code>、<code>struct</code>）、方法调用的局部变量、参数</td><td style="text-align: left">引用类型（<code>class</code>、<code>string</code>、<code>数组</code>）的对象实例</td></tr>
<tr><td style="text-align: left"><strong>分配与释放</strong></td><td style="text-align: left">自动分配/释放（方法结束时立即回收） 速度快（移动栈指针）</td><td style="text-align: left">手动分配/GC自动回收 速度较慢（需内存管理）</td></tr>
<tr><td style="text-align: left"><strong>生命周期</strong></td><td style="text-align: left">与方法调用绑定，作用域结束立即失效</td><td style="text-align: left">由GC管理，可能存活多轮垃圾回收（分代机制）</td></tr>
<tr><td style="text-align: left"><strong>访问速度</strong></td><td style="text-align: left">极快（直接操作内存，CPU缓存友好）</td><td style="text-align: left">较慢（需通过引用间接访问）</td></tr>
<tr><td style="text-align: left"><strong>大小限制</strong></td><td style="text-align: left">固定大小（默认1MB/线程） 栈溢出引发 <code>StackOverflowException</code></td><td style="text-align: left">仅受虚拟内存限制（GB级） 溢出引发 <code>OutOfMemoryException</code></td></tr>
<tr><td style="text-align: left"><strong>典型场景</strong></td><td style="text-align: left">临时变量、方法参数、线程独占数据</td><td style="text-align: left">对象实例、集合、共享数据</td></tr>
</tbody></table>
</div>
<h2 id="c可否对内存进行直接的操作"><a class="header" href="#c可否对内存进行直接的操作">C#可否对内存进行直接的操作？</a></h2>
<p>C#在Unsafe 模式下可以使用指针对内存进行操作, 但在托管模式下不可以使用指针。</p>
<ol>
<li>
<p>在 Visual Studio 开发环境中设置/unsafe（启用不安全模式)编译器选项
打开项目的“属性”页。
单击“生成”属性页。
选中“允许不安全代码”复选框。</p>
</li>
<li>
<p>unsafe关键字表示不安全上下文，该上下文是任何涉及指针的操作所必需的。
可以在类型或成员的声明中使用 unsafe修饰符。
因此，类型或成员的整个正文范围均被视为不安全上下文。例如，以下是用 unsafe 修饰符声明的方法：</p>
<pre><code class="language-csharp">unsafe static void FastCopy(byte[] src, byte[] dst, int count)
{
	// Unsafe context: can use pointers here.
}
</code></pre>
<p>不安全上下文的范围从参数列表扩展到方法的结尾，因此指针在以下参数列表中也可以使用：</p>
<pre><code class="language-csharp">unsafe static void FastCopy ( byte* ps, byte* pd, int count ) {...}
</code></pre>
<p>还可以使用不安全块从而能够使用该块内的不安全代码。例如：</p>
<pre><code class="language-csharp">unsafe
{
	// Unsafe context: can use pointers here.
}
</code></pre>
<p>若要编译不安全代码，必须指定 /unsafe编译器选项。
无法通过公共语言运行库验证不安全代码。</p>
</li>
</ol>
<h2 id="using-语法有用吗什么是idisposable"><a class="header" href="#using-语法有用吗什么是idisposable">using() 语法有用吗？什么是IDisposable？</a></h2>
<p>有用，实现了IDisposiable的类在using中创建，using结束后会自定调用该对象的Dispose方法，释放资源。</p>
<h2 id="using-语句会被编译成什么代码"><a class="header" href="#using-语句会被编译成什么代码">using 语句会被编译成什么代码？</a></h2>
<pre><code class="language-csharp">// 编译前
using (var resource = new FileStream(...)) { ... }

// 编译后（等价于）
FileStream resource = null;
try {
    resource = new FileStream(...);
    ...
} finally {
    resource?.Dispose();
}
</code></pre>
<h2 id="ctsclsclr分别作何解释"><a class="header" href="#ctsclsclr分别作何解释">CTS、CLS、CLR分别作何解释？</a></h2>
<p>CTS：通用语言系统。CLS：通用语言规范。CLR：公共语言运行库。</p>
<h2 id="什么是受管制的代码"><a class="header" href="#什么是受管制的代码">什么是受管制的代码？</a></h2>
<p>unsafe：非托管代码。不经过CLR运行。</p>
<h2 id="什么是托管代码非托管代码托管代码-managed-code"><a class="header" href="#什么是托管代码非托管代码托管代码-managed-code">什么是托管代码、非托管代码托管代码 (managed code)</a></h2>
<p>托管代码</p>
<p>由公共语言运行库环境（而不是直接由操作系统）执行的代码。托管代码应用程序可以获得公共语言运行库服务，例如自动垃圾回收、运行库类型检查和安全支持等。这些服务帮助提供独立于平台和语言的、统一的托管代码应用程序行为。有关内存管理（内存申请，内存释放，垃圾回收之类的）全部都是.net 的CLR来管理。</p>
<p>非托管代码 (unmanaged code)</p>
<p>在公共语言运行库环境的外部，由操作系统直接执行的代码。非托管代码必须提供自己的垃圾回收、类型检查、安全支持等服务；它与托管代码不同，后者从公共语言运行库中获得这些服务。内存回收要继承IDisposable 接口手动回收。</p>
<h2 id="gc是什么-为什么要有gc"><a class="header" href="#gc是什么-为什么要有gc">GC是什么? 为什么要有GC?</a></h2>
<ol>
<li>GC是垃圾收集器。程序员不用担心内存管理，因为垃圾收集器会自动进行管理.</li>
<li>.NET的GC机制有这样两个问题：首先，GC并不是能释放所有的资源。它不能自动释放非托管资源。</li>
</ol>
<p>GC并不是实时性的，这将会造成系统性能上的瓶颈和不确定性。</p>
<p>GC就是对“不可达“的对象进行回收，释放内存。</p>
<h2 id="如何解决net中的内存泄漏问题用到过哪些检测工具"><a class="header" href="#如何解决net中的内存泄漏问题用到过哪些检测工具">如何解决.net中的内存泄漏问题？用到过哪些检测工具？</a></h2>
<p>.NET内存泄漏，更准确的说应该是对象超过生命周期而不能被GC回收。</p>
<p><strong>常见的内存泄露有：</strong></p>
<ul>
<li>a、静态引用；</li>
<li>b、控件不使用后未销毁；</li>
<li>c、调用非托管资源而未释放；</li>
<li>d、事件注册后未解除注册，等。</li>
</ul>
<p><strong>解决方案：</strong></p>
<ul>
<li>(1) Dispose()的使用
如果使用的对象提供Dispose（）方法，那么当你使用完毕或在必要的地方（比如Exception）调用该方法，特别是对非托管对象,一定要加以调 用，以达到防止泄露的目的。</li>
<li>(2) using的使用
using除了引用Dll的功用外，还可以限制对象的适用范围，当超出这个界限后对象自动释放，比如using语句的用途定义一个范围，将在此范围之外释放一个或多个对象。</li>
<li>(3) 事件的卸载
这个不是必须的，推荐这样做。之前注册了的事件，关闭画面时应该手动注销，有利于GC回收资源。</li>
<li>(4) API的调用
一般的使用API了就意味着使用了非托管资源，需要根据情况手动释放所占资源，特别是在处理大对象时。4.5继承 IDisposable实现自己内存释放接口　Net 如何继承IDisposable接口，实现自己的Dispose()函数</li>
<li>(5)弱引用（WeakReference ）
通常情况下，一个实例如果被其他实例引用了，那么他就不会被GC回收，而弱引用的意思是，如果一个实例没有被其他实例引用（真实引用），而仅仅是被弱引用，那么他就会被GC回收。</li>
</ul>
<p><strong>诊断工具：</strong></p>
<ul>
<li>a、大多使用windows自带的perfmon.msc，</li>
<li>b、用过的工具里面CLRProfiler 和dotTrace还行，windbg也还行。不过坦白的说，准确定位比较费劲，最好还是按常规的该Dispose的加Dispose，也可以加 GC.Collect（）</li>
</ul>
<h2 id="内存泄漏和内存溢出的区别是什么"><a class="header" href="#内存泄漏和内存溢出的区别是什么">内存泄漏和内存溢出的区别是什么？</a></h2>
<p>简单来说，操作系统就像资源分配人员，你要使用内存的时候分给你，你用完了还给它。如果你使用了没有分配给你的内存就是内存溢出，如果你用完了没有了就是内存泄漏。</p>
<p><strong>会引起的问题：</strong></p>
<p>内存溢出存在的问题是你用了没有分配给你的内存，系统是不知道的，他又把内存分配给了其他程序，结果就是别人也写了或者读了这个内存。程序可能崩溃。当然也可能没问题，所以内存溢出往往不好查。</p>
<p>内存泄漏的问题就比理解，你没有还给系统，系统的内存就越来越少。直到没有可用内存。</p>
<p>泄漏是占着不用了，溢出是用不该用的地方；溢出一般会出事，泄漏在内存无限时不会出事。</p>
<p>泄漏是说你的程序有BUG 导致内存不释放。溢出是指内存不够用了 导致不够用的原因很多 泄漏只是其中一种。</p>

                        </div>
                        <div id="sidetoc">
                            <nav id="pagetoc"></nav>
                        </div>
                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                            <a rel="prev" href="exception.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>

                            <a rel="next prefetch" href="delegate.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>

                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                    <a rel="prev" href="exception.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>

                    <a rel="next prefetch" href="delegate.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
            </nav>

        </div>




        <script>
            window.playground_copyable = true;
        </script>


        <script src="elasticlunr.min.js"></script>
        <script src="mark.min.js"></script>
        <script src="searcher.js"></script>

        <script src="clipboard.min.js"></script>
        <script src="highlight.js"></script>
        <script src="book.js"></script>

        <!-- Custom JS scripts -->
        <script src="theme/pagetoc.js"></script>


    </div>
    </body>
</html>